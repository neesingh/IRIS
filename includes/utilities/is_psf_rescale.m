function [ PSF_resized, PSF_cropped ] = is_psf_rescale(PSF, scale, method, clip, apo, threshold)% Clip the PSF to its very borders and rescale it.%        if nargin < 6 || isempty(threshold), threshold = 0.05; end      % fraction of PSF maximum that must be exceeded to be included    if nargin < 5 || isempty(apo), apo = 1; end                     % create a vignette around the PSF    if nargin < 4 || isempty(clip), clip = 1; end                   % the default is to clip    if nargin < 3 || isempty(method), method = 'lanczos3'; end    if(apo == 1)        % Darken the circumference of the PSF. This is done because the tails of the PSFs often extend beyond the        % support matrix, and in case of GO PSF there are artifacts at the edges that screw up the clipping.        % the window shape was arrived at empirically :)                [x, y] = meshgrid(linspace(-1, 1, size(PSF,1)));        apo = (x.*x+y.*y)/2;                                 apo = exp(-8*pi*apo.*apo.*apo.*apo);        apo = apo/max(apo(:));        apo = apo.^4;        PSF = PSF .* apo;    end    PSF_cropped = PSF;        if(clip == 1)        PSF_bin = PSF > threshold * max(PSF(:));                y = sum(PSF_bin,1) > 0;        x = sum(PSF_bin,2)'> 0;        min_x = find(x, 1, 'first');        min_y = find(y, 1, 'first');        max_x = find(x, 1, 'last');        max_y = find(y, 1, 'last');        PSF = PSF(min_x:max_x, min_y:max_y);        % make the PSF square by padding the smaller of the two dimensions        size_x = size(PSF,2);        size_y = size(PSF,1);        if(size_x ~= size_y)            [val, dim] = max([size_y, size_x]);            idx = floor(abs(size_y - size_x)/2);            idx = max(1,idx);            canvas = zeros(val, val);            if(dim == 1) % more columns than rows                canvas(:, idx:idx+size_x-1) = PSF;            else                canvas(idx:idx+size_y-1, :) = PSF;            end            PSF_cropped = canvas;        else            PSF_cropped = PSF;        end    end        % LNT comment 17Apr10. Prior to today, interpolation method was 'bicubic'    % which can produce negative values of PSFroi. Not a good idea! So change    % to 'bilinear' interpolation.    PSF_resized = imresize(PSF_cropped, scale, method, 'Antialiasing', false);end